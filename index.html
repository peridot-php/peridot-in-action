<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Peridot In Action - Sensible BDD In PHP</title>

		<meta name="description" content="Use peridot for practical BDD">
		<meta name="author" content="Brian Scaturro">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/sky.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->

		<style type="text/css">
		.sequence-group {
			background:white;
			border:1px solid #efefef !important;
			text-align:left;
			overflow:hidden;
			padding:10px 10px 2px 10px !important;
			width: 400px;
			margin: 0 auto !important;
		}

			.sequence-group .sequence-text {
				font-size: 22px;
				float:left;
				margin:0 0 0 8px;
			}

			.sequence-group .sequence-number {
				background-color:#3b759e;
				color: #fff;
				border-radius: 50%;
				clear:left;
				font-size: 12px;
				float:left;
				padding: 6px 10px;
				margin-bottom: 10px;
			}

		.reveal pre {
			box-shadow: none;
		}
		</style>

	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<section>
					<h1>Peridot In Action</h1>
					<h4>Peridot In The Grand Scheme Of Things</h4>
					<p>
						<small>
							By <a href="https://github.com/brianium">Brian Scaturro</a> / <a href="https://twitter.com/scaturr">@scaturr</a>
						</small>
                    </p>
                    <p>
                        Code samples extracted from <a href="https://github.com/brianium/behavior-driven-todos">Behavior Driven Todos</a>
                    </p>
				</section> <!-- Intro -->

				<section>

					<section>
						<h2>What is BDD?</h2>

						<p>
							BDD = <strong>B</strong>ehavior <strong>D</strong>riven <strong>D</strong>evelopment
						</p>
					</section>

					<section>
						<h3>What do we mean by behavior?</h3>
						<ol>
							<li>
								That stuff users do.
							</li>
							<li>
								The thing your application does.
							</li>
							<li>
								What code does.
							</li>
						</ol>
					</section>

					<section>
						<h3>The BDD Lifecycle</h3>
						<p style="font-size:18px;">
							(Start with Behat)
						</p>
						<div class="sequence-group">
							<div class="sequence">
								<div class="sequence-number">1</div>
								<p class="sequence-text">
									Focus on one scenario
								</p>
							</div>

							<div class="sequence">
								<div class="sequence-number">2</div>
								<p class="sequence-text">
									Write a failing step definition
								</p>
							</div>
						</div>

						<p style="font-size:18px;">
							(Drop down to Peridot)
						</p>

						<div class="sequence-group">
							<div class="sequence">
								<div class="sequence-number">3</div>
								<p class="sequence-text">
									Write a failing spec
								</p>
							</div>

							<div class="sequence">
								<div class="sequence-number">4</div>
								<p class="sequence-text">
									Get the spec to pass
								</p>
							</div>

							<div class="sequence">
								<div class="sequence-number">5</div>
								<p class="sequence-text">
									Refactor
								</p>
							</div>
						</div>

						<p style="font-size:18px;">
							(When the step is passing)
						</p>

						<div class="sequence-group">
							<div class="sequence">
								<div class="sequence-number">7</div>
								<p class="sequence-text">
									Refactor
								</p>
							</div>
						</div>

					</section>

					<section>
						<h3>Why it matters</h3>

						<p>
							Focus on the how, not the what
						</p>

						<ul>
							<li>How should the application function?</li>
							<li>How do objects and functions interact?</li>
							<li>Did we meet our application/code expectations?</li>
						</ul>
					</section>

				</section> <!-- What is BDD? -->

				<section>

					<section>
						<img width="650" style="border:none;box-shadow:none;background:none;" src="https://raw.githubusercontent.com/peridot-php/peridot/master/logo.png" alt="Peridot">
						<p>
							<q cite="http://peridot-php.github.io/">highly extensible, highly enjoyable, BDD testing framework for PHP</q>
						</p>
					</section>

					<section>
						<h3>Hello Peridot!</h3>
						<pre>
							<code data-trim contenteditable class="php">
&lt;?php
describe('ArrayObject', function () {
    beforeEach(function () {
        $this->arrayObject = new ArrayObject(['one', 'two', 'three']);
    });

    describe('->count()', function () {
        it('should return the number of items', function () {
            $count = $this->arrayObject->count();
            assert($count === 3, 'expected 3');
        });
    });
});
							</code>
						</pre>
					</section>

					<section>
						<h3>Peridot's Role</h3>

						<p>
							An easy to use BDD/TDD tool. Useful for testing units, libraries, and apps!
						</p>
					</section>

				</section> <!-- Peridot -->

				<section>

					<section>
						<img width="500" style="border:none;box-shadow:none;background:none;" src="https://camo.githubusercontent.com/d8d967f1ba57d0f7857152ff0c3ca6503deb48f4/68747470733a2f2f646c2e64726f70626f7875736572636f6e74656e742e636f6d2f752f3238323739372f62656861742f62656861742e706e67" alt="Behat">
						<p>
							<q cite="https://github.com/Behat/Behat">A BDD framework for PHP to help you test business expectations.</q>
						</p>
					</section>

					<section>
						<h3>Hello Behat</h3>
						<h4>Features</h4>
						<pre>
							<code class="gherkin" contenteditable data-trim>
Feature: toggling the status of a todo

As a user
I want to be able to mark todos complete

Scenario: viewing a done todo
  Given I have a done todo "Get groceries"
  When I am on "/"
  Then I should see 1 ".todo-complete" element after waiting
							</code>
						</pre>
					</section>

					<section>
						<h4>Contexts</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
class FeatureContext
{
    /**
     * @Given I have a done todo :arg1
     */
    public function iHaveADoneTodo($todoText)
    {
        $collection = self::getTodoCollection();
        $collection->insert(['label' => $todoText, 'done' => true]);
    }

    /**
     * Opens specified page.
     *
     * @Given /^(?:|I )am on "(?P&lt;page&gt;[^"]+)"$/
     * @When /^(?:|I )go to "(?P&lt;page&gt;[^"]+)"$/
     */
    public function visit($page)
    {
        $this->visitPath($page);
    }

    /**
     * @Then I should see :arg2 :arg1 element(s) after waiting
     */
    public function iShouldSeeElementAfterWaiting($number, $selector)
    {
        $this->getSession()->wait(10000, "document.querySelectorAll('$selector').length === $number");
        $this->assertNumElements($number, $selector);
    }
}
							</code>
						</pre>
					</section>

					<section>
						<h3>Behat's Role</h3>
						<p>
							Great for acceptance tests, planning, and testing business expectations.
						</p>
					</section>

					<section>
						<h3>Mink</h3>
						<p>
							Browser emulation for PHP. The Mink extension for Behat is great for automating application
							acceptance tests that use Selenium WebDriver.
						</p>
					</section>

					<section>
						<p>
							<img width="250" style="border:none;box-shadow:none;background:none;" src="https://raw.githubusercontent.com/peridot-php/peridot/master/logo.png" alt="Peridot"> <span style="position:relative; bottom: 40px; right: 8px;">+</span> <img width="200" style="border:none;box-shadow:none;background:none;" src="https://camo.githubusercontent.com/d8d967f1ba57d0f7857152ff0c3ca6503deb48f4/68747470733a2f2f646c2e64726f70626f7875736572636f6e74656e742e636f6d2f752f3238323739372f62656861742f62656861742e706e67" alt="Behat"> <span style="position:relative; bottom: 40px;">= BDD Nirvana</span>
						</p>
					</section>

				</section> <!-- Behat -->

				<section>

					<section>
						<h2>Planning</h2>
					</section>

					<section>
						<h3>User Stories</h3>
						<h4>MUST!</h4>

						<ul>
							<li><em>Have business value</em></li>
							<li><em>Be testable</em></li>
							<li><em>Be small enough to implement in one iteration</em></li>
						</ul>
					</section>

					<section>
						<h3>Acceptance test-driven planning with Behat</h3>
						<p>
							In an ideal world, we gather around this acceptance criteria during planning and write testable acceptance criteria with stakeholders.
						</p>
						<p>
							We can translate our user stories into automated acceptance tests with Behat!
						</p>
					</section>

				</section> <!-- Planning -->

				<section>

					<section>
						<h2>BDD Lifecycle In Action</h2>
					</section>

					<section>
						<h3>A Failing Scenario</h3>
						<pre>
							<code class="gherkin" contenteditable data-trim>
Feature: initial visit to the todo app

As a user
I want to input todos
So I can track my business

Scenario: visiting todos for the first time
  Given I am on "/"
  Then I should see "Todos"
  And I should see a "#todo" element
							</code>
						</pre>
					</section>

					<section>
						<img src="img/failing-scenario.png" alt="failing scenario">
					</section>

					<section>
						<h3>Get to green!</h3>
						<pre>
							<code class="html" contenteditable data-trim>
&lt;!-- public/index.php --&gt;
&lt;h1&gt;Todos&lt;h1&gt;
&lt;input type="text" id="todo" /&gt;
							</code>
						</pre>
					</section>

					<section>
						<img src="img/passing-scenario.png" alt="passing scenario">
					</section>

					<section>
						<h3>Repeat!</h3> <!-- add todo feature -->
						<pre>
							<code class="gherkin" contenteditable data-trim>
Feature: adding a todo

As a user
I want my todos to be persisted
So I don't have to retype them

Scenario: adding a todo
  Given I am on "/"
  When I fill in "todo" with "Get groceries"
  And I press "add"
  And I reload the page
  Then I should see "Get groceries"
							</code>
						</pre>
					</section>

					<section>
						<img src="img/failing-scenario2.png" alt="failing add todo scenario">
					</section>

					<section>
						<h3>We can pass that step!</h3>
						<pre>
							<code class="html" contenteditable data-trim>
&lt;!-- public/index.php --&gt;
&lt;h1&gt;Todos&lt;h1&gt;
&lt;input type="text" id="todo" /&gt; &lt;button id="add"&gt;add&lt;/button&gt;
							</code>
						</pre>
					</section>

					<section>
						<img src="img/still-failing.png" alt="still failing scenario">
					</section>

					<section>
						<h3>Getting Serious</h3> <!-- introducing silex to the project -->
						<p>
							We've started our acceptance test cadence. However - we need to come to terms with reality:
							A single index.php probably won't cut it. We need to start writing real code.
						</p>
					</section>

					<section>
						<div style="position:relative; bottom: 200px;">
							<img style="border:none; background:none; box-shadow:none;" src="http://silex.sensiolabs.org/images/logo.png" />
							<p>
								The decision has been made to use a framework for the code behind the features. We happen to like <a href="http://silex.sensiolabs.org/">Silex</a>.
							</p>
						</div>
					</section>

					<section>
						<h3>Drop to Peridot</h3>
						<p>
							We need to start writing code to support the features of our todo application. We are at a point where we want to pursue
							BDD at the unit level.
						</p>
					</section>

					<section>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
use Symfony\Component\HttpFoundation\Request;

describe('TodosController', function () {

    beforeEach(function () {
        $this->controller = new TodosController();
    });

    describe('->create()', function () {

        it('should insert a todo', function () {
            $request = Request::create('/todos', 'POST', [], [], [], [], json_encode([
                'label' => 'Get groceries'
            ]));

            $this->controller->create($request);
            // what is our behavior?
        });
    });
});
							</code>
						</pre>
					</section>

					<section>
						<h3>Peridot And Prophecy</h3>
						<p>
							Mocks and spies are a great way to verify behavior. Peridot has a plugin for
							using the amazing mocking framework: <a href="https://github.com/phpspec/prophecy">Prophecy</a>
						</p>
					</section>

					<section>
						<h3>Using Plugins</h3>
						<p>
							Plugins are installed like any other package, and are included via the peridot.php file contained in the project root.
						</p>
					</section>

					<section>
						<h4>Registering the Prophecy plugin</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php //peridot.php
use Peridot\Plugin\Prophecy\ProphecyPlugin;

// if peridot.php returns a closure it will be called with
// the Peridot event emitter, a key component to extending Peridot
return function($emitter) {
    $prophecy = new ProphecyPlugin($emitter);
};
							</code>
						</pre>
						<p>
							This plugin adds Prophecy functionality to our specs.
						</p>
					</section>

					<section>
						<h4>Testing Behavior With Mocks</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
use Symfony\Component\HttpFoundation\Request;
use Brianium\Todos\Controller\TodosController;

describe('TodosController', function () {

    beforeEach(function () {
        $this->collection = $this->getProphet()->prophesize('MongoCollection');
        $this->controller = new TodosController($this->collection->reveal());
    });

    describe('->create()', function () {

        beforeEach(function () {
            $this->data = ['label' => 'Get groceries'];
        });

        it('should insert a todo', function () {
            $request = Request::create('/todos', 'POST', [], [], [], [], json_encode([
                'label' => 'Get groceries'
            ]));

            $this->controller->create($request);

            $this->collection->insert($this->data)->shouldBeCalled(); //thanks Prophecy!
            $this->getProphet()->checkPredictions();
        });
    });
});
							</code>
						</pre>
					</section>

					<section>
						<img src="img/failing-spec.png" alt="failing peridot spec" />
					</section>

					<section>
						<h4>Fix one thing at a time</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
namespace Brianium\Todos\Controller;

class TodosController
{

}
							</code>
						</pre>
					</section>

					<section>
						<img src="img/failing-spec2.png" alt="another failing peridot spec">
					</section>

					<section>
						<h4>Keeping making fixes</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
namespace Brianium\Todos\Controller;

class TodosController
{
    public function create()
    {

    }
}
							</code>
						</pre>
					</section>

					<section>
						<img src="img/failing-spec3.png" alt="yet another failing peridot spec" />
					</section>

					<section>
						<h4>Bring it on home</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
namespace Brianium\Todos\Controller;

use MongoCollection;
use Symfony\Component\HttpFoundation\Request;

class TodosController
{
    private $todos;

    public function __construct(MongoCollection $todos)
    {
        $this->todos = $todos;
    }

    public function create(Request $request)
    {
        $payload = json_decode($request->getContent(), true);
        $this->todos->insert($payload);
    }
}
							</code>
						</pre>
					</section>

					<section>
						<img src="img/passing-spec.png" alt="passing peridot spec">
					</section>

					<section>
						<p>To make our API useful, we should return our new resource</p>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
use Symfony\Component\HttpFoundation\Request;
use Brianium\Todos\Controller\TodosController;

describe('TodosController', function () {

    beforeEach(function () {
        $this->collection = $this->getProphet()->prophesize('MongoCollection');
        $this->controller = new TodosController($this->collection->reveal());
    });

    describe('->create()', function () {

        beforeEach(function () {
            $this->data = ['label' => 'Get groceries'];
            $this->request = Request::create('/todos', 'POST', [], [], [], [], json_encode($this->data));
        });

        it('should insert a todo', function () {
            $this->controller->create($this->request);

            $this->collection->insert($this->data)->shouldBeCalled();
            $this->getProphet()->checkPredictions();
        });

        it('should return the new todo', function () {
            $response = $this->controller->create($this->request);

            $todo = json_decode($response->getContent());

            assert($todo->label == 'Get groceries');
        });
    });
});
							</code>
						</pre>
					</section>

					<section>
						<img src="img/failing-spec4.png" alt="no response returned" />
					</section>

					<section>
						<h4>Returning the newly created resource</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
namespace Brianium\Todos\Controller;

use MongoCollection;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\JsonResponse;

class TodosController
{
    private $todos;

    public function __construct(MongoCollection $todos)
    {
        $this->todos = $todos;
    }

    public function create(Request $request)
    {
        $payload = json_decode($request->getContent(), true);
        $this->todos->insert($payload);
        return JsonResponse::create($payload);
    }
}
							</code>
						</pre>
					</section>

					<section>
						<img src="img/passing-spec2.png" alt="second passing peridot spec" />
					</section>

				</section> <!-- BDD Lifecycle In Action -->

				<section>

					<section>
						<h2>Finishing Our Feature</h2>
					</section>

					<section>
						<h4>using twig to render our todos</h4>
						<pre>
							<code class="twig" contenteditable data-trim>
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Todo List&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Todos&lt;/h1&gt;
    &lt;input type="text" id="todo" /&gt; &lt;button id="add"&gt;add&lt;/button&gt;
    &lt;ul id="todos"&gt;
      {% for todo in todos %}
      &lt;li&gt;{{ todo.label }}&lt;/li&gt;
      {% endfor %}
    &lt;/ul&gt;

    &lt;script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/3.5.0/lodash.min.js"&gt;&lt;/script&gt;
    &lt;script src="//code.jquery.com/jquery-2.1.3.min.js"&gt;&lt;/script&gt;
    &lt;script src="js/todos.js"&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
							</code>
						</pre>
					</section>

					<section>
						<h4>A controller action for index</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
namespace Brianium\Todos\Controller;

use MongoCollection;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\JsonResponse;
use Twig_Environment;

class TodosController
{
    private $todos;
    private $twig;

    public function __construct(MongoCollection $todos, Twig_Environment $twig)
    {
        $this->todos = $todos;
        $this->twig = $twig;
    }

    public function index()
    {
        $content = $this->twig->render('index.twig', ['todos' => $this->todos->find()]);
        return Response::create($content);
    }

    public function create(Request $request)
    {
        $payload = json_decode($request->getContent(), true);
        $this->todos->insert($payload);
        return JsonResponse::create($payload);
    }
}
							</code>
						</pre>
					</section>

					<section>
						<h4>A Sprinkle Of JavaScript</h4>
						<pre>
							<code class="javascript" contenteditable data-trim>
(function () {

  var todo = $('#todo'),
      add = $('#add'),
      list = $('#todos');

  /**
   * Returns an event handler that appends
   * text from input to a list element.
   *
   * @param {jQuery} list
   * @param {jQuery} input
   * @return {Function}
   */
  function append(list, input) {
    return function () {
      var val = input.val();
      list.append('&lt;li&gt;' + val + '&lt;/li&gt;');
      return val;
    };
  }

  /**
   * Persist the todo
   *
   * @param {String} val the todo label
   */
  function create(val) {
    $.ajax({
      method: 'POST',
      url: '/todos',
      data: JSON.stringify({label: val}),
      contentType: 'application/json',
      dataType: 'json'
    });
  }

  add.click(_.compose(create, append(list, todo)));

})();
							</code>
						</pre>
					</section>

					<section>
						<h3>Our Passing Feature</h3>
						<img src="img/finished-feature.png" alt="finished todo">
					</section>

					<section>
						<h4>Reference: Silex App File</h4>
						<p>
							How Silex works is beyond the scope of this talk, but if you want to refer to the todo app to
							see how a controller is tied to a route, take a look at the <a href="https://github.com/brianium/behavior-driven-todos/blob/bfaffb1a883789e31bbf4e6216e48c0fd0b06467/app/app.php">app file</a>.
						</p>
					</section>

				</section> <!-- Finishing Our Feature -->

				<section>
					<h2>Iterate! Iterate! Iterate!</h2>
				</section> <!-- Iterate -->

				<section>

					<section>
						<h2>Sidebar: Peridot for route tests</h2>
						<p>
							A lot of behavior, especially for APIs, ends up outside of the context
							of a controller - usually in the form of middleware. This is a good thing, especially when it is repeated everywhere.
						</p>
					</section>

					<section>
						<h4>The HttpKernel Plugin</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
use Peridot\Plugin\Prophecy\ProphecyPlugin;
use Peridot\Plugin\HttpKernel\HttpKernelPlugin;

return function($emitter) {
    $prophecy = new ProphecyPlugin($emitter);

    //set up app tests
    $app = include __DIR__ . '/app/app.php';
    $app['debug'] = true;
    $app['exception_handler']-&gt;disable();
    $app['todos-collection'] = $app['mongo-client']-&gt;test-&gt;todos;
    HttpKernelPlugin::register($emitter, $app);
};
							</code>
						</pre>
					</section>

					<section>
						<h4>Testing high level API behavior</h4>
						<pre>
							<code class="php" contenteditable data-trim>
&lt;?php
describe('/todos/{id}', function () {

    beforeEach(function () {
        $app = $this->getHttpKernelApplication();
        $app['todos-collection']->remove();

        $this->document = ['label' => 'Do a thing!'];
        $app['todos-collection']->insert($this->document);
    });

    describe('POST', function () {

        it('should return an error response if the todo already exists', function () {
            $this->client->request('POST', '/todos', [], [], [], '{"label":"Do a thing!"}');

            $response = $this->client->getResponse();

            assert($response->getStatusCode() === 422);
        });

    });
});
							</code>
						</pre>
					</section>

				</section> <!-- Route Tests -->

				<section style="text-align:left;">
					<h2>Questions?</h2>

					<p>
						- <a href="https://github.com/brianium/behavior-driven-todos">Full Todo App</a><br>
						- <a href="https://github.com/peridot-php">Peridot On GitHub</a>
					</p>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
